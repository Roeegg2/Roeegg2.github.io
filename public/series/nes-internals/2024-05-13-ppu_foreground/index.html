<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=42897&amp;path=livereload" data-no-instant defer></script>
<title>The NES Internals Series: chapter 3 - PPU Foreground Rendering</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">















  






      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css" integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">



















</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/posts">
                    Single Posts
                </a>
                
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/series">
                    Series
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    About
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#terminology" class="nav-terminology">
									Terminology
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#oam" class="nav-oam">
									OAM
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#byte-0" class="nav-byte-0">
									Byte 0
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#byte-1" class="nav-byte-1">
									Byte 1
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#byte-2" class="nav-byte-2">
									Byte 2
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#byte-3" class="nav-byte-3">
									Byte 3
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#dma" class="nav-dma">
									DMA
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#sprite-priority--overlapping" class="nav-sprite-priority--overlapping">
									Sprite priority &amp; overlapping
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#question-2-answer" class="nav-question-2-answer">
									Question 2 answer:
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#question-1-answer" class="nav-question-1-answer">
									Question 1 answer:
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="http://localhost:42897/">
            My New Hugo Site
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="http://localhost:42897/">
        <div class="single-column-header-title">My New Hugo Site</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    The NES Internals Series: chapter 3 - PPU Foreground Rendering
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2024-04-13 15:13
                        </time>
                        

                        

                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="terminology">Terminology</h2>
<ul>
<li><strong>DMA</strong> - a component in a computer system which can access the system RAM, and other storage areas directly and move data between them without needing the CPU.
As always, if you want to understand better, go look it up online</li>
</ul>
<h2 id="oam">OAM</h2>
<p>The OAM (object attribute memory) is the place where sprites are stored. It has the size of 256 bytes, and can store 64 sprites.
Using a short calculation, we get that each sprite entry is the size of <code>256/64 = 4 Bytes</code>.</p>
<p>There is another memory area called secondary OAM, which can hold up to 8 sprites (32 bytes).
Data is written to OAM, and then transfered over to secondary OAM, from which the sprites are actually drawn</p>
<h3 id="byte-0">Byte 0</h3>
<p>This byte contains the Y position of the sprite, counted from the top of the screen.
The value here is actually subtracted by 1, to get the actual Y value of the sprite. I will explain the reasoning behind this later on.</p>
<h3 id="byte-1">Byte 1</h3>
<p>This byte contains the tile number to be used, to index into the pattern tables.
Its use differs between 8x16 and 8x8:</p>
<p>From the background graphics chapter, we already know we know the PPU can address 2 pattern tables (<code>$0000-$0fff</code> and <code>$1000-$1fff</code>).
For 8x8 sprites, the decision of which pattern table to use is given by bit 3 of PPUCTRL.
For 8x16 sprites, bit 0 of the this byte, is used to select the pattern table.</p>
<h3 id="byte-2">Byte 2</h3>
<p>This byte contains some important attribute data about the sprite: palette group used, sprite priority, and whether the sprite should be rendered flipped (both vertically or horizontally)</p>
<h3 id="byte-3">Byte 3</h3>
<p>The X position of the sprite, counted from the left of the sprite (ie the first pixel)</p>
<p>Thats it! That&rsquo;s how sprites are represented in the NES.</p>
<h2 id="dma">DMA</h2>
<p>Remember I said the PPU copies data from primary OAM into secondary OAM?
Well the PPU has 2 options to perform these copies:</p>
<ol>
<li>Copying using OAMADDR and OAMDATA</li>
<li>Copying using DMA</li>
</ol>
<blockquote>
<p><strong><em>NOTE:</em></strong> In contrast to the usual way a the case of the NES, the CPU is actually halted while the DMA is copying data to secondary OAM, so it doesn&rsquo;t have that advantage, but the copy is actually way faster using DMA (it takes 2 cycles to copy a byte using DMA, and the CPU has overhead of resolving the addressing mode, fetching the next instruction, etc.)</p>
</blockquote>
<p>In order to instruct the DMA to activate, and copy the contents of <em>primary OAM</em> into <em>secondary OAM</em>, the programmer can write some value to the <strong>OAMDMA</strong> register.
After that register is written the CPU is halted and a copy takes place.</p>
<h2 id="sprite-priority--overlapping">Sprite priority &amp; overlapping</h2>
<p>*As we&rsquo;ve seen, the <em>PPU background</em> and <em>PPU foreground</em> rendering mechanism operates independently of each other.</p>
<ol>
<li>So what happens when a sprite pixel overlaps a background pixel?</li>
<li>And if we&rsquo;re already talking about overlapping, what happens if we have 2 sprites which overlap on some pixel?</li>
</ol>
<h3 id="question-2-answer">Question 2 answer:</h3>
<p>Sprite priority is determined by the position of the sprites in OAM - the lower the sprite position is (0, 1, 2) the higher it&rsquo;s priority is.
So if Sprite A overlaps Sprite B at some pixel, and lets say Sprite A is at OAM index 4, and Sprite B is at OAM index 20, then Sprite A &ldquo;wins&rdquo; and gets to have the pixel!</p>
<h3 id="question-1-answer">Question 1 answer:</h3>
<p>Quoted from the NESdev wiki: <em>&ldquo;if the frontmost opaque sprite&rsquo;s priority bit is true (1), an opaque background pixel is drawn in front of it.&rdquo;</em></p>
<blockquote>
<p><strong><em>NOTE:</em></strong> Yes, if a sprites priority bit is 1, it means it should be <strong>behind</strong> the background. If it&rsquo;s 0 then it should be <strong>infront</strong> of background.</p>
</blockquote>
<p>These weird behaviors have let NES game developers to create some unique and creative visual effects.</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2024-04-13</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/series/nes-internals/2024-04-22-cart-and-mappers/">
			Next<br>The NES Internals Series: chapter 4 - Game Cartrdiges &amp; Mappers
                </a>
                
                
                
                <a class="older-posts" href="/series/nes-internals/2024-04-06-ppu-background/">
			Previous<br>The NES Internals Series: chapter 2 - PPU Background
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












            </div>
        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="http://localhost:42897/">
    
        <div class="nav-title">
            My New Hugo Site
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/posts">
                Single Posts
            </a>
            
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/series">
                Series
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                About
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2024 My New Hugo Site
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#terminology" class="nav-terminology">
									Terminology
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#oam" class="nav-oam">
									OAM
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#byte-0" class="nav-byte-0">
									Byte 0
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#byte-1" class="nav-byte-1">
									Byte 1
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#byte-2" class="nav-byte-2">
									Byte 2
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#byte-3" class="nav-byte-3">
									Byte 3
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#dma" class="nav-dma">
									DMA
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#sprite-priority--overlapping" class="nav-sprite-priority--overlapping">
									Sprite priority &amp; overlapping
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#question-2-answer" class="nav-question-2-answer">
									Question 2 answer:
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#question-1-answer" class="nav-question-1-answer">
									Question 1 answer:
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>

<div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2024 My New Hugo Site
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
